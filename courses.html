<!DOCTYPE html>
<html>

<head>
    <title>Courses - Course Registration System</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="{{ url_for('static', filename='script.js') }}"></script>
</head>

<body>
    <div class="container">
        <div class="header-section">
            <h1>üìö Course Registration System</h1>
            <div class="user-info">
                <span>Welcome, <strong>{{ username }}</strong> ({{ role }})</span>
                {% if role == "Student" %}
                <a href="/my_courses" class="dashboard-btn">My Courses</a>
                {% endif %}
                <a href="/logout" class="logout-btn">Logout</a>
            </div>
        </div>

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                <div class="alert alert-{{ category }}">
                    {{ message }}
                    <button class="close-btn" onclick="this.parentElement.style.display='none'">&times;</button>
                </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Statistics Dashboard -->
        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-number">{{ stats.total_courses }}</div>
                <div class="stat-label">Total Courses</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ stats.total_enrollments }}</div>
                <div class="stat-label">Total Enrollments</div>
            </div>
            {% if role == "Student" %}
            <div class="stat-card highlight">
                <div class="stat-number">{{ stats.my_courses }}</div>
                <div class="stat-label">My Enrolled Courses</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ stats.available_courses }}</div>
                <div class="stat-label">Available to Enroll</div>
            </div>
            {% endif %}
        </div>

        {% if role == "Admin" %}
        <div class="add-course-section">
            <h2>‚ûï Add New Course</h2>
            <form class="add-course-form" action="/add_course" method="post">
                <input type="text" name="cid" placeholder="Course ID (e.g., CS101)" required>
                <input type="text" name="name" placeholder="Course Name" required>
                <input type="text" name="instructor" placeholder="Instructor Name" required>
                <input type="text" name="fee" placeholder="Fee (e.g., ‚Çπ9999 or Free)" value="Free">                <input type="number" name="capacity" placeholder="Max Seats" value="30" min="1" style="width: 120px;">                <input type="text" name="notes" placeholder="Course Notes/Description" style="width: 300px;">
                <button type="submit" class="add-btn">Add Course</button>
            </form>
        </div>
        {% endif %}

        <div class="courses-section">
            <div class="section-header">
                <h2>üìñ All Available Courses ({{ courses|length }})</h2>
                <!-- Search Box -->
                <form method="get" action="/courses" class="search-form">
                    <input type="text" name="search" placeholder="üîç Search by ID, name, or instructor..." 
                           value="{{ search_query or '' }}" class="search-input">
                    <button type="submit" class="search-btn">Search</button>
                    {% if search_query %}
                    <a href="/courses" class="clear-btn">Clear</a>
                    {% endif %}
                </form>
            </div>
            
            {% if courses %}
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Course ID</th>
                            <th>Course Name</th>
                            <th>Instructor</th>
                            <th>Fee</th>
                            <th>Seats</th>
                            <th>Notes</th>
                            <th>Added By</th>
                            <th>Enrolled Students</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for course in courses %}
                        <tr>
                            <td class="course-id">{{ course.course_id }}</td>
                            <td class="course-name">{{ course.name }}</td>
                            <td>{{ course.instructor }}</td>
                            <td class="course-fee">
                                <span class="fee-badge">{{ course.fee }}</span>
                            </td>
                            <td class="seats-cell">
                                {% set enrolled = enrollments.get(course.course_id, [])|length %}
                                {% set available = course.capacity - enrolled %}
                                {% if available == 0 %}
                                <span class="seat-badge full">0/{{ course.capacity }}</span>
                                {% elif available <= 5 %}
                                <span class="seat-badge filling">{{ available }}/{{ course.capacity }}</span>
                                {% else %}
                                <span class="seat-badge available">{{ available }}/{{ course.capacity }}</span>
                                {% endif %}
                            </td>
                            <td class="course-notes">
                                <span title="{{ course.notes }}">
                                    {{ course.notes[:40] }}{% if course.notes|length > 40 %}...{% endif %}
                                </span>
                            </td>
                            <td class="added-by">{{ course.added_by if course.added_by else 'N/A' }}</td>
                            <td class="students-cell">
                                {% if enrollments.get(course.course_id) %}
                                <div class="students-count">
                                    <strong>{{ enrollments[course.course_id]|length }} student(s):</strong>
                                </div>
                                <ul class="student-list">
                                    {% for s in enrollments[course.course_id] %}
                                    <li class="student-item">
                                        <span class="student-name">üë§ {{ s }}</span>
                                        {% if role == "Admin" %}
                                        <form action="/delete_enrollment" method="post" class="inline-form">
                                            <input type="hidden" name="student" value="{{ s }}">
                                            <input type="hidden" name="course_id" value="{{ course.course_id }}">
                                            <button class="delete-btn" type="submit" onclick="return confirm('Remove {{ s }} from {{ course.name }}?')">‚ùå</button>
                                        </form>
                                        {% endif %}
                                    </li>
                                    {% endfor %}
                                </ul>
                                {% else %}
                                <p class="no-students"><em>No students enrolled yet</em></p>
                                {% endif %}
                            </td>
                            <td class="action-cell">
                                {% if role == "Student" %}
                                    {% set is_enrolled = course.course_id in my_enrollments %}
                                    {% set enrolled_count = enrollments.get(course.course_id, [])|length %}
                                    {% set is_full = enrolled_count >= course.capacity %}
                                    {% if is_enrolled %}
                                    <form action="/unenroll" method="post" class="inline-form">
                                        <input type="hidden" name="course_id" value="{{ course.course_id }}">
                                        <button type="submit" class="unenroll-btn" onclick="return confirm('Unenroll from {{ course.name }}?')">Drop Course</button>
                                    </form>
                                    {% elif is_full %}
                                    <button class="full-btn" disabled>Course Full</button>
                                    {% else %}
                                    <form action="/enroll" method="post" class="inline-form">
                                        <input type="hidden" name="course_id" value="{{ course.course_id }}">
                                        <button type="submit" class="enroll-btn">Enroll Now</button>
                                    </form>
                                    {% endif %}
                                {% elif role == "Admin" %}
                                <form action="/delete_course" method="post" class="inline-form">
                                    <input type="hidden" name="course_id" value="{{ course.course_id }}">
                                    <button type="submit" class="delete-course-btn" onclick="return confirm('Delete {{ course.name }}? This will remove all enrollments!')">üóëÔ∏è Delete</button>
                                </form>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="empty-state">
                {% if search_query %}
                <p>üîç No courses found matching "{{ search_query }}"</p>
                <a href="/courses" class="btn-primary">View All Courses</a>
                {% else %}
                <p>üì≠ No courses available yet.</p>
                {% if role == "Admin" %}
                <p>Add your first course using the form above!</p>
                {% endif %}
                {% endif %}
            </div>
            {% endif %}
        </div>

        {% if role == "Student" %}
        <div class="info-box">
            <strong>‚ÑπÔ∏è Student Guide:</strong> 
            Click "Enroll Now" to register for courses. Use "Drop Course" to unenroll. 
            View your enrolled courses in <a href="/my_courses" style="color: #0c5460; font-weight: bold;">My Courses</a> page.
        </div>
        {% endif %}

        {% if role == "Admin" %}
        <div class="info-box">
            <strong>‚ÑπÔ∏è Admin Panel:</strong> 
            You can add new courses, delete courses, and manage student enrollments. 
            All courses added will be tracked with your username.
        </div>
        {% endif %}
    </div>
</body>

</html>
